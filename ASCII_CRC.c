/******************************************************************************

                            Online C Compiler.
                Code, Compile, Run and Debug C program online.
Write your code in this editor and press "Run" button to compile and execute it.

*******************************************************************************/

#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void hexToasciihex(int rcv, int *byte_H, int *byte_L)
{
	*byte_H = ((rcv)>>4) & 0x0F;
	//printf("\r\n byte_H = %x \r\n",*byte_H);
	
	if((*byte_H)<=9)
		*byte_H = *byte_H + '0';
	else
		*byte_H = *byte_H + '0'+7;
	//printf("\r\n byte_H = %x \r\n",*byte_H);
	
	*byte_L =  rcv & 0x0F;
	//printf("\r\n byte_L = %x \r\n",*byte_L);
	
	if((*byte_L)<=9)
		*byte_L =  *byte_L  + '0';
	else
		*byte_L =  *byte_L  + '0' + 7;
	//printf("\r\n byte_L = %x \r\n",*byte_L);
}

int calculate_ascii_crc(int *buf, int start, int len)
{
	int crc =0;
	int pos;

	for (pos = start; pos <= len; pos++)
	{
		//printf("\r\n buf[pos] = %x\r\n",buf[pos]);
		crc = crc + buf[pos];			// XOR byte into least sig. byte of crc
		//printf("\r\n crc = %x \r\n",crc);
	}
	
	crc = (0xFFFF - crc) + 1;
	//printf("\r\n crc = %x \r\n",crc);

	// Note, this number has low and high bytes swapped, so use it accordingly (or swap bytes)
	return crc;
}

int main()
{
	int calcrc = 0;
	int ascii_hex_data[4];
	
	union U16{
		int data[4];
		int u_data;
	}U;

//	int byteCount = 298;
//	int rs485RespData[298] = {0x7E, 0x31, 0x31, 0x30, 0x31, 0x44, 0x30, 0x30, 0x30, 0x36, 0x31, 0x31, 0x38, 0x30, 0x43, 0x45, 0x36, 0x30, 0x43, 0x44, 0x39, 0x31, 0x39, 0x31, 0x39, 0x31, 0x33, 0x34, 0x39, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x36, 0x34, 0x31, 0x44, 0x34, 0x43, 0x36, 0x34, 0x30, 0x45, 0x41, 0x36, 0x36, 0x34, 0x30, 0x31, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x32, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x33, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x34, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x35, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x36, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x30, 0x37, 0x43, 0x38, 0x30, 0x34, 0x0D};
	
	int byteCount = 20;
	int rs485RespData[20] = {0x7e, 0x31, 0x31, 0x30, 0x31, 0x44, 0x30, 0x38, 0x32, 0x45, 0x30, 0x30, 0x32, 0x30, 0x31, 0x46, 0x44, 0x35, 0x39, 0x0d};
	
	int *response = rs485RespData;
	
	U.data[0] = response[byteCount - 5];
	U.data[1] = response[byteCount - 4];
	U.data[2] = response[byteCount - 3];
	U.data[3] = response[byteCount - 2];

	calcrc = calculate_ascii_crc(response, 1, (byteCount - 6));

	hexToasciihex(((calcrc >> 8) & 0xff), &ascii_hex_data[0], &ascii_hex_data[1]);
	hexToasciihex(((calcrc) & 0xff), &ascii_hex_data[2], &ascii_hex_data[3]);

	printf("U.data[0]: %02X\tascii_hex_data[0]: %02X\r\n", U.data[0], ascii_hex_data[0]);
	printf("U.data[1]: %02X\tascii_hex_data[1]: %02X\r\n", U.data[1], ascii_hex_data[1]);
	printf("U.data[2]: %02X\tascii_hex_data[2]: %02X\r\n", U.data[2], ascii_hex_data[2]);
	printf("U.data[3]: %02X\tascii_hex_data[3]: %02X\r\n", U.data[3], ascii_hex_data[3]);

	return 0;
}
